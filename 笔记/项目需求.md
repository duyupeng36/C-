# 项目需求

私有协议文件管理服务器项目(网盘项目)将分 $5$ 期完成。前 $2$ 期将完成大部分基础功能，后 $3$ 期将添加一些列的其他额外功能

## 一期功能

一期功能将完成服务端和客户端的框架编写，并且实现下表列出的几项功能。客户端读取命名并解析命令，然后客户端向服务器发起请求

| 功能       | 描述          |
| :------- | ----------- |
| `mkdir`  | 创建目录        |
| `rmdir`  | 删除空目录       |
| `cd`     | 切换目录        |
| `pwd`    | 查看当前目录      |
| `ls`     | 列出目录下的文件    |
| `puts`   | 上传文件到服务端    |
| `gets`   | 从服务端下载文件到本地 |
| `remove` | 删除服务器上的文件   |

### 目录相关操作

对于不同的用户，他们的根目录在服务端的位置是不同的。然而，在客户端展示的都是 `/` 开头的目录

为了在服务端区分不同用户，我们需要在服务端主机中新建一个 `netdisk` 目录，并以用户名在该目录下创建一个子目录。例如，假设有两个用户，他们的用户名分别为 `dyp` 和 `mike`。为了区分这两个用户的根目录，就需要在 `netdisk` 中新建两个目录，分别命名为 `dyp` 和 `mike`。如下所示

```shell
➜  ~ tree netdisk
netdisk
├── dyp
└── mike
```

> [!tip] 
> `netdisk/dyp` 和 `netdisk/mike` 是客户端对应的根目录，均展示为 `/`
> 

#### mkdir 和 rmdir 命令

`mkdir` 命令用于创建目录，服务端接收到该命令后就应该 **在用户的当前工作目录中创建一个目录**。该命命令只需要简单调用 `mkdir()` 系统调用即可 ^[[[目录与链接#创建和移除目录]]]

`rmdir` 命令用于删除空目录，服务端接收到该命令后就应该将当前用户指定的目录进行删除。该命令也只需要简单调用 `rmdir()` 系统调用即可 ^[[[目录与链接#创建和移除目录]]]

#### cd 命令

`cd` 命令用于修改当前工作目录，服务端接收到该命令后就应该转到 `cd` 命令指定的目录中

> [!attention] 
> 
> 注意，我们不应该修改服务端进程的当前工作目录。因为，服务端需要服务多个用户，而且采用的线程池服务端框架，如果修改了服务端进程的当前工作目录就会影响其他用户
> 

经过上述目录设计，我们让服务端为每个用户记录一个 **当前工作目录(Current Word Director CWD)**，服务端每次接收到 `cd` 命令就会修改当前工作目录

> [!example] 
> 
> 服务端为每个用户维持了一个变量 `cwd`。假设用户 `mike` 登陆时，该变量被设置为 `$HOME/netdisk/mike`
> 
> 当客户端发送命令 `cd movie` 时，服务端将 `cwd` 修改为 `$HOME/netdisk/mike/movie`
> 
> 当客户端发送命令 `cd /` 时，服务端将 `cwd` 修改为 `$HOME/netdisk/mike`
>

显然，`cd` 命令每次都是对 `cwd` 的尾部进行操作。这操作类似于 [[栈和队列#栈|栈]]，在实现该命令的时候，我们需要将 `cwd` 实现为一个 **栈**

#### pwd 命令

该命令只需要遍历 `cwd` 结构即可

#### ls 命令

`ls` 命令用与列出指定目录下的文件，服务端接收到该命令时就应该检查指定的目录是否存在，然后使用 `opendir()` 和 `readdir()` 查看目录下的文件

### 其他命令

#### puts 和 gets 命令

`puts` 命令将本地文件上传到服务端，服务端接收到该命令时就会准备接收文件

`gets` 命令将服务端中的文件下载到本地，服务端接收到该命令就会将文件发送给客户端

#### remove 命令

`remove` 命令将指定的文件，服务端接收到该命令就会检查指定文件是否存在，然后删除指定文件

## 二期功能

二期将完成 **密码认证**，**日志记录**，**断点续传**，**大文件的零拷贝**

### 密码认证

由于没有接入数据，这里我借用 Linux 用户进行密码认证。关于 Linux 密码认证参考 [[用户和组#密码加密和用户认证]]

### 日志记录

服务端作为守护进程启动，不会在控制台输出任何消息。为了记录服务端的运行信息，采用 syslog 作为日志记录。详细参考 [[守护进程#syslog 记录日志]]

### 断点续传

客户端在下载文件时，首先检查本地是否有该文件，然后读取本地文件的大小。客户端将本地文件大小传递给服务端，服务端跳过一下子的文件大小，然后才开始传输

